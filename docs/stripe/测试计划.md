# 测试计划

积分数据规则，全部可以配置化：
- 匿名用户送Free积分：1，7天过期
- 注册用户送Free积分：2，7天过期，会刷新Free积分类型的最新有效期
- OneTimePaid积分，有效期：30天
  - F1卡片：$5购买     5积分
  - P2卡片：$10购买  10积分
  - U3卡片：$20购买  20积分
- Monthly月付 购买Paid积分
  - F1卡片：不可购买
  - P2卡片：$10/月购买  100积分
  - U3卡片：$50/月购买  800积分
- Yearly年付 购买Paid积分
  - F1卡片：不可购买
  - P2卡片：$8/月购买，实际要支付 12*8=$96 购买 1200积分
  - U3卡片：$40/月购买，实际要支付 12*40=$480 购买 9600积分

## 环境准备
- 数据库：建库`db.init.sql`，建表`create.sql`；  如果要反复进行测试需要清理遗留数据，可以使用`purge.sql`清表
- 代码及配置：拉取最新代码，同步`.env.local`环境配置；
- 编译运行：在根目录 `pnpm install`；再`pnpm ddaas:build`编译；最后运行`pnpm ddaas:dev`
- 第三方Webhook CLI：
  - 注册用户、删除用户时需要启动本地事件监听：`npx localtunnel --port 3000 --subdomain ddaas-clerk`
  - Stripe测试时需要启动本地事件监听：`stripe listen --forward-to localhost:3000/api/webhook/stripe`


## 场景集成测试

- 匿名用户初始化：检查用户信息，无积分组件显示，✅
- 注册：检查用户信息，注册后自动登录，有积分组件 ✅
- 价格卡片状态MOCK验证：通过更改环境变量配置，来直接模拟Free|MonthlyPro|MonthlyUltra|YearlyPro|YearlyUltra 用户 ✅
- 购买一次性积分包：跳转到Stripe支付，需要使用一些特殊账号，支付成功的✅；支付失败但Checkout完成的，❎无法测
- 购买订阅：跳转到Stripe支付，需要使用一些特殊账号，支付成功的✅；支付失败但Checkout完成的  ❎无法测
- 再购买一次性积分包：跳转到Stripe支付，这里是验证OneTime支付与订阅支付完全隔离互不影响 ✅
- 管理订阅(跳转到门户)：看到订阅计划和支付记录，可以取消订阅(下个周期才真实生效)，后期可以升级产品 ✅
- 取消订阅：用户操作下个周期才生效，管理员可以立即取消，触发事件 ✅
- 用户注销：会数据备份，再清理数据 ✅

## 数据验证
- 匿名用户、注册后，在调试面板查看状态积分数据
- 购买一次性积分、订阅积分后查看积分数据以及有效期
- 取消订阅、用户注销后也检查积分数据
- 模拟Stripe的失败事件后也检查积分、订阅状态、有效期等