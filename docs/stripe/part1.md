# Part 1: 概述与需求分析

## 1. 设计背景

### 1.1 现有系统概述
当前系统（V1.0）是一个基于Stripe的订阅与积分管理系统，具备以下特点：
- **用户体系**：支持匿名用户到注册用户的完整生命周期（已通过生产验证，保持不变）
- **支付模式**：仅支持Stripe订阅模式（subscription）
- **积分系统**：完善的免费积分和付费积分管理机制
- **前端组件**：Money Price组件已支持OneTime即付模式（参考 docs/codex-money.md）
- **Stripe API版本**：2025-09-30.clover

### 1.2 核心问题与机遇
**当前限制**：
- Stripe配置硬编码为subscription模式（apps/ddaas/src/lib/stripe-config.ts:41）
- 缺少一次性支付（OneTime Payment）的后端支持
- 订阅用户无法灵活购买积分包

**市场机遇**：
- 用户付费偏好多样化，部分用户更倾向于按需购买而非订阅
- 订阅用户在有效期内可能需要临时增加积分额度
- 灵活的混合付费模式能提高用户转化率和ARPU值

---

## 2. 新设计核心需求

### 2.1 支付模式升级
从"仅支持订阅模式"升级到"订阅 + 一次性支付混合模式"：

| 支付模式 | 用户场景 | 核心价值 |
|---------|---------|---------|
| **订阅模式**（Subscription） | 长期稳定使用 | 每月/年自动续费 + 周期性积分充值 |
| **一次性支付**（OneTime Payment） | 按需购买积分 | 灵活购买积分包，无订阅承诺 |
| **混合模式** | 订阅用户补充积分 | 订阅基础额度 + 按需购买额外积分 |

### 2.2 业务逻辑规则

#### 规则1：订阅用户的订阅有效期
```
订阅有效期 = 当前时间 到 +366天 23:59:59
```
- 无论月付/年付，首次订阅或续费时，订阅有效期统一设置为366天
- 在订阅有效期内，用户享有订阅会员权益
- 订阅有效期结束后，需要续费才能继续享有会员权益

#### 规则2：积分分配逻辑
```
订阅付费 → 分配积分 + 设置订阅有效期
一次性支付 → 仅分配积分（不影响订阅状态）
```

**场景示例**：
1. **无订阅用户购买订阅**：
   - 支付成功 → 创建订阅记录 → 设置有效期（now + 366天）→ 充值订阅配套积分

2. **无订阅用户购买积分包**：
   - 支付成功 → 充值积分 → 无订阅状态变化

3. **有订阅用户购买积分包**：
   - 支付成功 → 充值积分 → 订阅状态不变

4. **有订阅用户续订**：
   - 支付成功 → 更新有效期（now + 366天）→ 充值订阅配套积分

#### 规则3：用户状态与购买权限
| 用户状态 | 可购买订阅 | 可购买积分包 | 说明 |
|---------|-----------|-------------|------|
| 匿名用户 | ✅ 需先注册 | ✅ 需先注册 | 引导注册后购买 |
| 注册用户（无订阅） | ✅ | ✅ | 无限制 |
| 注册用户（有订阅） | ✅ 升级/续费 | ✅ | 订阅期内可随时购买积分包 |

---

## 3. 架构升级策略

### 3.1 保留不变的部分（已验证）
1. **用户体系**：
   - User表结构
   - 匿名用户识别（Fingerprint）
   - 用户注册/登录流程（Clerk集成）
   - 用户注销与数据备份机制

2. **积分管理核心**：
   - Credit表结构（免费积分/付费积分分离）
   - 积分消耗逻辑（优先free，后paid）
   - CreditUsage审计记录

3. **前端组件**：
   - Money Price组件（已支持OneTime模式）

### 3.2 需要升级的部分
1. **Subscription表**：
   - 新增字段支持366天订阅有效期逻辑
   - 优化订阅状态管理

2. **Transaction表**：
   - 完善一次性支付的类型标识
   - 增强订单类型区分

3. **Stripe配置**：
   - 支持payment模式（一次性支付）
   - 动态模式选择逻辑

4. **Webhook处理**：
   - 新增payment_intent相关事件处理
   - 优化订阅事件处理逻辑

---

## 4. 技术约束与兼容性

### 4.1 技术约束
- **Stripe API版本**：严格使用 2025-09-30.clover
- **数据库**：PostgreSQL（Prisma ORM）
- **现有代码保持**：用户服务代码不变

### 4.2 向后兼容性保证
- 现有订阅用户数据无需迁移
- 现有API接口向后兼容
- 新增功能通过参数控制，不影响现有流程

### 4.3 数据一致性要求
- 订单创建与支付完成的原子性保证
- 积分充值与订阅状态更新的事务一致性
- 失败场景的回滚机制

---

## 5. 设计目标与验收标准

### 5.1 功能目标
- [ ] 支持Stripe一次性支付（payment模式）
- [ ] 支持订阅用户在有效期内购买积分包
- [ ] 实现366天订阅有效期逻辑
- [ ] 完善Webhook事件处理（payment_intent + subscription）
- [ ] 前后端完整联调通过

### 5.2 性能目标
- Webhook处理响应时间 < 500ms
- 订单创建到支付完成的端到端延迟 < 3s
- 数据库查询优化，关键接口响应 < 200ms

### 5.3 质量目标
- 代码覆盖率 > 80%
- 关键支付流程集成测试覆盖
- 异常场景处理完善（支付失败、超时、重试）

---

## 6. 分阶段实施计划

### 阶段1：数据库设计（Part 2）
- 数据表字段调整
- 索引优化
- 数据迁移脚本（如需）

### 阶段2：支付流程设计（Part 3）
- 订阅流程重构（366天有效期）
- 一次性支付流程设计
- 积分充值逻辑优化

### 阶段3：Stripe集成实现（Part 4）
- API接口设计
- Webhook事件处理
- 错误处理与日志

### 阶段4：测试与上线
- 单元测试 + 集成测试
- Stripe测试环境验证
- 生产环境灰度发布

---

## 7. 风险与应对

### 7.1 技术风险
| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| Stripe API变更 | 高 | 锁定API版本，监控Stripe官方变更通知 |
| Webhook重复投递 | 中 | 实现幂等性机制（基于event_id去重） |
| 数据库事务失败 | 高 | 完善回滚机制，增加异常监控告警 |

### 7.2 业务风险
| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 订阅与积分包定价混乱 | 中 | 配置化管理，前端组件统一价格展示 |
| 用户对366天有效期理解偏差 | 中 | UI明确展示有效期，邮件/站内信提醒 |
| 积分包购买频率过高 | 低 | 监控购买行为，必要时设置购买间隔限制 |

---

## 8. 下一步
详见后续文档：
- **Part 2**：数据库设计详解（表结构、字段、索引）
- **Part 3**：支付流程与业务逻辑（流程图、时序图、状态机）
- **Part 4**：Stripe集成与API设计（接口定义、Webhook处理、错误处理）
